<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using BedTool objects as iterators/generators &mdash; pybedtools 0.7.5 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.7.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="pybedtools 0.7.5 documentation" href="index.html" />
    <link rel="up" title="Topical Documentation" href="topical-documentation-contents.html" />
    <link rel="next" title="Low-level operations" href="topical-low-level-ops.html" />
    <link rel="prev" title="Saving BedTool results" href="topical-saving.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="topical-low-level-ops.html" title="Low-level operations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="topical-saving.html" title="Saving BedTool results"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pybedtools 0.7.5 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="topical-documentation-contents.html" accesskey="U">Topical Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-bedtool-objects-as-iterators-generators">
<span id="bedtools-as-iterators"></span><h1>Using BedTool objects as iterators/generators<a class="headerlink" href="#using-bedtool-objects-as-iterators-generators" title="Permalink to this headline">Â¶</a></h1>
<p>Typically, <code class="xref py py-mod docutils literal"><span class="pre">BedTool</span></code> objects are used somewhat like handles to individual
files on disk that contain BED lines.  To save disk space, <code class="xref py py-mod docutils literal"><span class="pre">BedTool</span></code>
objects also have the ability to &quot;stream&quot;, much like piping in Unix.  That
is, the data are created only one line at a time in memory, instead of
either creating a list of all data in memory or writing all data to disk.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You'll need to be careful when using <code class="xref py py-mod docutils literal"><span class="pre">BedTool</span></code> objects as
generators, since any operation that reads all the features of a
<code class="xref py py-mod docutils literal"><span class="pre">BedTool</span></code> will consume the iterable.</p>
</div>
<p>To get a streaming BedTool, use the <code class="docutils literal"><span class="pre">stream=True</span></code> kwarg.  This
<code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code> will act a little differently from a standard, file-based
<code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;b.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># checking the length consumes the iterator</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="go">3</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># nothing left, so checking length again returns 0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="go">0</span>
</pre></div>
</div>
<p>In some cases, a stream may be &quot;rendered&quot; to a temp file.  This is because
BEDTools programs can only accept one input file as <code class="docutils literal"><span class="pre">stdin</span></code>.  This is typically
the first input (<code class="docutils literal"><span class="pre">-i</span></code> or <code class="docutils literal"><span class="pre">-a</span></code>), while the other input (<code class="docutils literal"><span class="pre">-b</span></code>) must be a file.
Consider this example, where the second intersection needs to convert the
streaming BedTool to a file before sending to <code class="docutils literal"><span class="pre">intersectBed</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;b.bed&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># first we set up a streaming BedTool:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># But supplying a streaming BedTool as the first unnamed argument</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># means it is being passed as -b to intersectBed, and so must be a file.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># In this case, `c` is rendered to a tempfile before being passed.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Chaining two streaming BedTool objects together?  You'll need to be
careful, because sometimes this will result in deadlocks.  You'll see zero
CPU usage as pybedtools tries to write to the stdin of a downstream BedTool
object.</p>
<p>For example, for two BedTool objects pointing to files that have &gt;5000
features, the following usually blocks:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>The solution is to save to a tempfile first, or use non-streaming BedTools.
All of the following will work fine:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="c"># only use file-based</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># using the second streaming BedTool is fine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># if you have a streaming BedTool, &quot;render&quot; it to a tempfile with</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># saveas()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">saveas</span><span class="p">()</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
<p>There's a nice explanation of blocking along with figures at
<a class="reference external" href="http://www.pixelbeat.org/programming/stdio_buffering/">http://www.pixelbeat.org/programming/stdio_buffering/</a>.  Most solutions to
this blocking problem on stackoverflow suggest using threads, but in my
test cases this tends to make interactive IPython sessions act strangely.
Another option is to try pexpect, but I have been unable to get this to
work and it requires an additional dependency.</p>
<p>Contributions to help solve this would be most appreciated!</p>
<p>Example references:</p>
<blockquote class="last">
<div><ul class="simple">
<li><a class="reference external" href="http://stackoverflow.com/questions/1595492/blocks-send-input-to-python-subprocess-pipeline">http://stackoverflow.com/questions/1595492/blocks-send-input-to-python-subprocess-pipeline</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/375427/non-blocking-read-on-a-subprocess-pipe-in-python">http://stackoverflow.com/questions/375427/non-blocking-read-on-a-subprocess-pipe-in-python</a></li>
<li><a class="reference external" href="http://www.python.org/dev/peps/pep-3145/">http://www.python.org/dev/peps/pep-3145/</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/3076542/how-can-i-read-all-availably-data-from-subprocess-popen-stdout-non-blocking/3078292#3078292">http://stackoverflow.com/questions/3076542/how-can-i-read-all-availably-data-from-subprocess-popen-stdout-non-blocking/3078292#3078292</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/3140189/subprocess-popen-stdout-reading-stdout-in-real-time-again">http://stackoverflow.com/questions/3140189/subprocess-popen-stdout-reading-stdout-in-real-time-again</a> (and references therein)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="creating-a-bedtool-from-an-iterable">
<h2>Creating a <code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code> from an iterable<a class="headerlink" href="#creating-a-bedtool-from-an-iterable" title="Permalink to this headline">Â¶</a></h2>
<p>You can create a <code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code> on the fly from a generator or iterator -- in
fact, this is what the <code class="xref py py-meth docutils literal"><span class="pre">BedTool.filter()</span></code> method does for you:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">chr1        1       100     feature1        0       +</span>
<span class="go">chr1        100     200     feature2        0       +</span>
<span class="go">chr1        150     500     feature3        0       -</span>
<span class="go">chr1        900     950     feature4        0       +</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">BedTool</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># this is the same as using filter:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<p>We need to &quot;render&quot; these BedTools to string before we can check equality
-- consuming them both -- since they are both iterables for which <code class="docutils literal"><span class="pre">==</span></code> is
not defined:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">==</span> <span class="n">c</span>
<span class="gt">Traceback (most recent call last):</span>
    <span class="o">...</span>
<span class="gr">NotImplementedError</span>: <span class="n">Testing equality only supported for BedTools that point to a file</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<div class="section" id="indexing-a-bedtool">
<h2>Indexing a <code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code><a class="headerlink" href="#indexing-a-bedtool" title="Permalink to this headline">Â¶</a></h2>
<p>In some cases it may be useful to index into a <code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code> object.  We can
use standard list slice syntax, and get an iterable of <code class="xref py py-class docutils literal"><span class="pre">Interval</span></code>
objects as a result.  This iterable can in turn be used to create a new <code class="xref py py-class docutils literal"><span class="pre">BedTool</span></code> instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="go">&lt;itertools.islice object at 0x...&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="go">chr1        150     500     feature3        0       -</span>
<span class="go">chr1        900     950     feature4        0       +</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s">&#39;b.bed&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">pybedtools</span><span class="o">.</span><span class="n">BedTool</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="go">chr1        155     200     feature2        0       +</span>
<span class="go">chr1        155     200     feature3        0       -</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using BedTool objects as iterators/generators</a><ul>
<li><a class="reference internal" href="#creating-a-bedtool-from-an-iterable">Creating a <code class="docutils literal"><span class="pre">BedTool</span></code> from an iterable</a></li>
<li><a class="reference internal" href="#indexing-a-bedtool">Indexing a <code class="docutils literal"><span class="pre">BedTool</span></code></a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="topical-saving.html"
                        title="previous chapter">Saving <code class="docutils literal"><span class="pre">BedTool</span></code> results</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="topical-low-level-ops.html"
                        title="next chapter">Low-level operations</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/topical-iterators.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="topical-low-level-ops.html" title="Low-level operations"
             >next</a> |</li>
        <li class="right" >
          <a href="topical-saving.html" title="Saving BedTool results"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pybedtools 0.7.5 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="topical-documentation-contents.html" >Topical Documentation</a> &raquo;</li> 
      </ul>
    </div>


    <div class="footer">
      &copy;2010-2015, Ryan Dale.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.3</a>
      
      |
      <a href="_sources/topical-iterators.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>